repeat task.wait() until game:IsLoaded()

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local TWEEN_SPEED = 20
local TELEPORT_DISTANCE = 200
local TELEPORT_POS = Vector3.new(-4995.14, 308.51, -25.02)
local totalCoins = 0

local CoinCollected
pcall(function()
	local GameplayRemotes = ReplicatedStorage:WaitForChild("Remotes", 5):WaitForChild("Gameplay", 5)
	CoinCollected = GameplayRemotes:FindFirstChild("CoinCollected")
end)

local ScreenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
ScreenGui.Name = "VxezeHubUI"
ScreenGui.ResetOnSpawn = false

local BlackScreen = Instance.new("Frame")
BlackScreen.BackgroundColor3 = Color3.new(0,0,0)
BlackScreen.BackgroundTransparency = 0
BlackScreen.AnchorPoint = Vector2.new(0.5,0.5)
BlackScreen.Position = UDim2.fromScale(0.5,0.5)
BlackScreen.Size = UDim2.new(2,0,2,0)
BlackScreen.ZIndex = 9998
BlackScreen.Parent = ScreenGui
BlackScreen.Visible = true

local ToggleLogo = Instance.new("ImageButton")
ToggleLogo.AnchorPoint = Vector2.new(0.5,0)
ToggleLogo.Position = UDim2.fromScale(0.5, 0.01)
ToggleLogo.Size = UDim2.new(0, 60, 0, 60)
ToggleLogo.BackgroundTransparency = 1
ToggleLogo.Image = "rbxassetid://139347223478721"
ToggleLogo.ZIndex = 10001
ToggleLogo.Parent = ScreenGui

local UIScale = Instance.new("UIScale", ToggleLogo)
ToggleLogo.MouseEnter:Connect(function()
	TweenService:Create(UIScale, TweenInfo.new(0.15), {Scale=1.1}):Play()
end)
ToggleLogo.MouseLeave:Connect(function()
	TweenService:Create(UIScale, TweenInfo.new(0.15), {Scale=1.0}):Play()
end)

ToggleLogo.MouseButton1Click:Connect(function()
	BlackScreen.Visible = not BlackScreen.Visible
end)

local StatusLabel = Instance.new("TextLabel")
StatusLabel.AnchorPoint = Vector2.new(0.5,0)
StatusLabel.Position = UDim2.fromScale(0.5, 0.2)
StatusLabel.Size = UDim2.new(0, 400, 0, 50)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Font = Enum.Font.GothamBold
StatusLabel.TextColor3 = Color3.new(1,1,1)
StatusLabel.TextSize = 28
StatusLabel.TextXAlignment = Enum.TextXAlignment.Center
StatusLabel.Text = "Status: Waiting For New Map"
StatusLabel.ZIndex = 10000
StatusLabel.Parent = ScreenGui

-- Total Coins
local TotalCoinLabel = Instance.new("TextLabel")
TotalCoinLabel.AnchorPoint = Vector2.new(0.5,0)
TotalCoinLabel.Position = UDim2.fromScale(0.5, 0.29)
TotalCoinLabel.Size = UDim2.new(0, 400, 0, 40)
TotalCoinLabel.BackgroundTransparency = 1
TotalCoinLabel.Font = Enum.Font.GothamBold
TotalCoinLabel.TextColor3 = Color3.new(1,1,1)
TotalCoinLabel.TextSize = 24
TotalCoinLabel.TextXAlignment = Enum.TextXAlignment.Center
TotalCoinLabel.Text = "Total Coins: 0"
TotalCoinLabel.ZIndex = 10000
TotalCoinLabel.Parent = ScreenGui

local function SetStatus(text)
	StatusLabel.Text = "Status: " .. text
end

if CoinCollected then
	CoinCollected.OnClientEvent:Connect(function(...)
		totalCoins += 1
		TotalCoinLabel.Text = "Total Coins: " .. tostring(totalCoins)
	end)
end

local visitedCoins, isFarming = {}, false

local function getCharacter()
	local char = player.Character or player.CharacterAdded:Wait()
	repeat task.wait() until char:FindFirstChild("HumanoidRootPart")
	return char, char.HumanoidRootPart
end

local function findActiveCoinContainer()
	for _, v in ipairs(Workspace:GetChildren()) do
		if v:FindFirstChild("CoinContainer") then
			return v.CoinContainer
		end
	end
	return nil
end

local function allCoinsGone(container)
	for _, c in ipairs(container:GetChildren()) do
		if c:IsA("BasePart") and c:FindFirstChild("CoinVisual") then
			return false
		end
	end
	return true
end

local function findNearestCoin(container, hrp)
	local nearest, dist = nil, math.huge
	for _, coin in ipairs(container:GetChildren()) do
		if coin:IsA("BasePart") and not visitedCoins[coin] then
			local d = (hrp.Position - coin.Position).Magnitude
			if d < dist then
				dist, nearest = d, coin
			end
		end
	end
	return nearest
end

local function moveToCoin(hrp, coin)
	if not coin or not coin:IsDescendantOf(Workspace) then return end
	visitedCoins[coin] = true
	local d = (hrp.Position - coin.Position).Magnitude
	if d > TELEPORT_DISTANCE then
		hrp.CFrame = CFrame.new(coin.Position)
	else
		local tween = TweenService:Create(hrp, TweenInfo.new(d / TWEEN_SPEED, Enum.EasingStyle.Linear), {CFrame = CFrame.new(coin.Position)})
		tween:Play()
		tween.Completed:Wait()
	end
end

local function startFarm()
	if isFarming then return end
	isFarming = true
	while true do
		local char, hrp = getCharacter()
		local container = findActiveCoinContainer()
		if not container then
			SetStatus("Waiting For New Map")
			repeat task.wait(1)
				container = findActiveCoinContainer()
			until container
		end
		SetStatus("Farming Candy")
		if allCoinsGone(container) then
			SetStatus("Teleporting...")
			hrp.CFrame = CFrame.new(TELEPORT_POS)
			visitedCoins = {}
			task.wait(3)
		else
			local coin = findNearestCoin(container, hrp)
			if coin then
				moveToCoin(hrp, coin)
			else
				task.wait()
			end
		end
	end
end

RunService.RenderStepped:Connect(function()
	BlackScreen.Size = UDim2.new(2,0,2,0)
	BlackScreen.Position = UDim2.fromScale(0.5,0.5)
end)

player.CharacterAdded:Connect(function()
	task.wait(2)
	startFarm()
end)
startFarm()